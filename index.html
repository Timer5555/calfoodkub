<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - Dark Mode</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Kanit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .nav-button {
            background-image: linear-gradient(to top, #4f46e5, #6366f1); /* indigo-600 to indigo-500 */
            color: white;
            transition: all 0.3s ease;
        }
        .nav-button.active {
            background-image: linear-gradient(to top, #3730a3, #4338ca); /* indigo-800 to indigo-700 */
            color: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }
        .tab-button {
            color: #94a3b8; /* slate-400 */
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            border-color: #818cf8; /* indigo-400 */
            background-color: #334155; /* slate-700 */
            font-weight: 600;
            color: #e0e7ff; /* indigo-200 */
        }
        .btn-grad {
            background-image: linear-gradient(to right, #4f46e5 0%, #6366f1 51%, #4f46e5 100%); /* indigo-600 to indigo-500 */
            transition: 0.5s;
            background-size: 200% auto;
            color: white;
            cursor: pointer;
        }
        .btn-grad:hover {
            background-position: right center;
        }
        .hidden-file-input {
            display: none;
        }
        .progress-bar {
            background-color: #475569; /* slate-600 */
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            background-color: #6366f1; /* indigo-500 */
            transition: width 0.5s ease-in-out;
            text-align: center;
            color: white;
            font-weight: bold;
        }
        .progress-bar-inner.over {
             background-color: #f43f5e; /* rose-500 */
        }
        .date-range-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">

    <div id="app-container" class="max-w-lg mx-auto min-h-screen bg-slate-800 shadow-lg">

        <!-- Main Content Area -->
        <main id="main-content" class="p-4 pb-24">
            <!-- Page 1: Input Page -->
            <div id="page-input">
                <h1 class="text-2xl font-bold text-slate-100 mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>
                <div class="flex border-b border-slate-600 mb-4">
                   
                    <button id="tab-btn-image" class="tab-button flex-1 py-2 px-4 border-b-2 border-transparent">‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                    <button id="tab-btn-text" class="tab-button flex-1 py-2 px-4 border-b-2 border-transparent">‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                    <button id="tab-btn-manual" class="tab-button flex-1 py-2 px-4 border-b-2 border-transparent">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</button>
                </div>
                <div id="tab-content-image" class="tab-panel">
                    <p class="text-sm text-slate-400 mb-2">AI ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                    <div class="bg-slate-700 p-4 rounded-lg text-center">
                        <img id="image-preview" class="hidden w-full max-w-xs mx-auto rounded-lg mb-4 shadow-md" alt="Image Preview">
                        <div class="flex space-x-2">
                            <label for="image-camera-input" class="flex-1 btn-grad p-3 rounded-lg">‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û üì∑</label>
                            <input type="file" id="image-camera-input" class="hidden-file-input" accept="image/*" capture="environment">
                            <label for="image-gallery-input" class="flex-1 btn-grad p-3 rounded-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏° üñºÔ∏è</label>
                            <input type="file" id="image-gallery-input" class="hidden-file-input" accept="image/*">
                        </div>
                         <p class="text-xs text-slate-500 mt-2">AI ‡∏≠‡∏≤‡∏à‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ</p>
                    </div>
                </div>
                <div id="tab-content-text" class="tab-panel hidden">
                    <p class="text-sm text-slate-400 mb-2">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
                    <textarea id="text-input" class="w-full p-3 border border-slate-600 rounded-lg bg-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-200" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏£‡∏≤‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö 1 ‡∏à‡∏≤‡∏ô..."></textarea>
                    <button id="analyze-text-btn" class="mt-2 w-full btn-grad p-3 rounded-lg">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                    <p class="text-sm text-slate-400 mt-4 mb-2">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</p>
                    <div class="bg-slate-700 p-4 rounded-lg text-center">
                        <img id="text-image-preview" class="hidden w-full max-w-xs mx-auto rounded-lg mb-4 shadow-md" alt="Text Image Preview">
                        <div class="flex space-x-2">
                            <label for="text-camera-input" class="flex-1 btn-grad p-3 rounded-lg">‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û üì∑</label>
                            <input type="file" id="text-camera-input" class="hidden-file-input" accept="image/*" capture="environment">
                            <label for="text-gallery-input" class="flex-1 btn-grad p-3 rounded-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏° üñºÔ∏è</label>
                            <input type="file" id="text-gallery-input" class="hidden-file-input" accept="image/*">
                        </div>
                    </div>
                </div>
                <div id="tab-content-manual" class="tab-panel hidden">
                    <p class="text-sm text-slate-400 mb-2">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏â‡∏•‡∏≤‡∏Å‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ</p>
                     <div class="bg-slate-700 p-4 rounded-lg">
                        <label for="manual-description" class="block text-left text-sm font-medium text-slate-300">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
                        <textarea id="manual-description" class="w-full mt-1 p-2 border border-slate-600 rounded-lg bg-slate-600 text-slate-200" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏•‡∏±‡∏î‡∏≠‡∏Å‡πÑ‡∏Å‡πà, ‡πÄ‡∏ß‡∏¢‡πå‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô 1 ‡∏™‡∏Å‡∏π‡πä‡∏õ"></textarea>
                        <p class="text-sm text-slate-400 mt-4 mb-2">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                        <img id="manual-image-preview" class="hidden w-full max-w-xs mx-auto rounded-lg mb-4 shadow-md" alt="Manual Image Preview">
                        <div class="flex space-x-2">
                             <label for="manual-camera-input" class="flex-1 btn-grad p-3 rounded-lg">‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û üì∑</label>
                            <input type="file" id="manual-camera-input" class="hidden-file-input" accept="image/*" capture="environment">
                            <label for="manual-gallery-input" class="flex-1 btn-grad p-3 rounded-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏° üñºÔ∏è</label>
                            <input type="file" id="manual-gallery-input" class="hidden-file-input" accept="image/*">
                        </div>
                    </div>
                </div>
                <div id="results-section" class="mt-6">
                    <h2 class="font-bold text-lg mb-2 text-slate-200">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå / ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                    <p id="ai-description" class="text-slate-300 mb-3"></p>
                    <div class="grid grid-cols-2 gap-3 text-slate-300">
                        <div>
                            <label for="calories" class="text-sm font-medium">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà (kcal)</label>
                            <input type="number" id="calories" class="w-full mt-1 p-2 border border-slate-600 rounded-lg bg-slate-700 text-slate-200" placeholder="0">
                        </div>
                        <div><label for="protein" class="text-sm font-medium">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (g)</label><input type="number" id="protein" class="w-full mt-1 p-2 border border-slate-600 rounded-lg bg-slate-700 text-slate-200" placeholder="0"></div>
                        <div><label for="carbs" class="text-sm font-medium">‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï (g)</label><input type="number" id="carbs" class="w-full mt-1 p-2 border border-slate-600 rounded-lg bg-slate-700 text-slate-200" placeholder="0"></div>
                        <div><label for="fat" class="text-sm font-medium">‡πÑ‡∏Ç‡∏°‡∏±‡∏ô (g)</label><input type="number" id="fat" class="w-full mt-1 p-2 border border-slate-600 rounded-lg bg-slate-700 text-slate-200" placeholder="0"></div>
                    </div>
                    <button id="save-btn" class="mt-6 w-full btn-grad p-4 rounded-lg font-bold text-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å üíæ</button>
                </div>
            </div>

            <!-- Page 2: Daily Dashboard -->
            <div id="page-daily-dashboard" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold text-slate-100">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h1>
                    <button id="settings-btn" class="text-slate-400 hover:text-indigo-400 p-2 rounded-full hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    </button>
                </div>
                <input type="date" id="date-picker" class="w-full p-2 border border-slate-600 bg-slate-700 rounded-lg mb-4 text-slate-200">
                <div id="daily-summary" class="bg-slate-700 p-4 rounded-lg mb-4">
                    <h2 class="font-bold text-lg mb-3 text-slate-200">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h2>
                    <div id="daily-comparison" class="space-y-2"></div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-slate-700 p-4 rounded-lg">
                        <h3 class="font-bold text-center mb-2 text-slate-200">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        <canvas id="daily-calorie-pie-chart"></canvas>
                    </div>
                    <div class="bg-slate-700 p-4 rounded-lg">
                        <h3 class="font-bold text-center mb-2 text-slate-200">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
                        <canvas id="daily-macro-pie-chart"></canvas>
                    </div>
                </div>
                <div>
                    <h2 class="font-bold text-lg mb-2 text-slate-200">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
                    <div id="daily-food-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- Page 3: Summary Dashboard -->
            <div id="page-summary-dashboard" class="hidden">
                <h1 class="text-2xl font-bold text-slate-100 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h1>
                <!-- Date Range Selection -->
                <div class="bg-slate-700 p-3 rounded-lg mb-4">
                    <div class="flex flex-wrap gap-2 justify-center mb-3">
                        <button class="date-range-btn flex-1 px-3 py-1 bg-slate-600 rounded-md text-sm" data-days="7">7 ‡∏ß‡∏±‡∏ô</button>
                        <button class="date-range-btn flex-1 px-3 py-1 bg-slate-600 rounded-md text-sm" data-days="14">14 ‡∏ß‡∏±‡∏ô</button>
                        <button class="date-range-btn flex-1 px-3 py-1 bg-slate-600 rounded-md text-sm" data-days="30">30 ‡∏ß‡∏±‡∏ô</button>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <input type="date" id="summary-start-date" class="w-full p-1 border border-slate-600 bg-slate-600 text-slate-200 rounded-md">
                        <span>‡∏ñ‡∏∂‡∏á</span>
                        <input type="date" id="summary-end-date" class="w-full p-1 border border-slate-600 bg-slate-600 text-slate-200 rounded-md">
                        <button id="summary-custom-range-btn" class="p-2 bg-indigo-600 text-white rounded-md">‡πÑ‡∏õ</button>
                    </div>
                </div>
                <div class="bg-slate-700 p-4 rounded-lg mb-4">
                    <h2 class="font-bold text-lg mb-2 text-slate-200">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</h2>
                    <canvas id="summary-line-chart"></canvas>
                </div>
                <div class="bg-slate-700 p-4 rounded-lg">
                    <h2 class="font-bold text-lg mb-2 text-slate-200">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏Å‡∏£‡∏±‡∏°)</h2>
                    <canvas id="summary-nutrient-chart"></canvas>
                </div>
            </div>
            
            <!-- Page 4: Settings -->
            <div id="page-settings" class="hidden">
                 <div class="flex items-center mb-4">
                    <button id="back-to-daily-btn" class="p-2 mr-2 rounded-full hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <h1 class="text-2xl font-bold text-slate-100">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h1>
                </div>
                <div class="bg-slate-700 p-4 rounded-lg space-y-4">
                    <div>
                        <label for="calorie-goal" class="block text-sm font-medium text-slate-300">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (kcal)</label>
                        <input type="number" id="calorie-goal" class="w-full mt-1 p-2 border border-slate-600 bg-slate-600 text-slate-200 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2000">
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-slate-300">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (%)</h3>
                        <p id="macro-percentage-total" class="text-xs text-slate-400 mb-2">‡∏£‡∏ß‡∏°: 100%</p>
                        <div class="grid grid-cols-3 gap-2">
                            <div><label for="protein-goal" class="block text-xs">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</label><input type="number" id="protein-goal" class="w-full mt-1 p-2 border border-slate-600 bg-slate-600 text-slate-200 rounded-lg macro-goal" placeholder="30"></div>
                            <div><label for="carb-goal" class="block text-xs">‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï</label><input type="number" id="carb-goal" class="w-full mt-1 p-2 border border-slate-600 bg-slate-600 text-slate-200 rounded-lg macro-goal" placeholder="40"></div>
                            <div><label for="fat-goal" class="block text-xs">‡πÑ‡∏Ç‡∏°‡∏±‡∏ô</label><input type="number" id="fat-goal" class="w-full mt-1 p-2 border border-slate-600 bg-slate-600 text-slate-200 rounded-lg macro-goal" placeholder="30"></div>
                        </div>
                    </div>
                     <button id="save-settings-btn" class="w-full btn-grad p-3 rounded-lg font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </div>
            </div>
        </main>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"><div class="bg-slate-800 p-5 rounded-lg flex items-center space-x-3"><svg class="animate-spin h-5 w-5 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</span></div></div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-slate-800 shadow-[0_-2px_10px_rgba(0,0,0,0.2)]"><div class="flex justify-around"><button id="nav-input" class="nav-button flex-1 text-center p-4"><span class="block">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ü§ñ</span></button><button id="nav-daily" class="nav-button flex-1 text-center p-4"><span class="block">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô üß†</span></button><button id="nav-summary" class="nav-button flex-1 text-center p-4"><span class="block">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° üìä</span></button></div></nav>

<script>
// =================================================================================
// CONFIGURATION
// =================================================================================
const GAS_URL = 'https://script.google.com/macros/s/AKfycby1SnxLya3mRKzBPcY-h7ofKjD_it8mdwq7R5wIteVXF9aHt3rTYFXFhvm0_uWBW4AW/exec'; // <--- PASTE YOUR WEB APP URL HERE
const GEMINI_API_KEY = 'AIzaSyB5uy029b5FBGO7jtLdCE5RE-RbinKUmK4';

// =================================================================================
// GLOBAL STATE
// =================================================================================
let currentTab = 'image';
let currentPage = 'input';
let selectedImageBase64 = null, selectedImageName = null, selectedImageType = null;
let dailyCaloriePieChart = null, dailyMacroPieChart = null, summaryLineChart = null, summaryNutrientChart = null;
let userSettings = { calorieGoal: 2000, proteinPercent: 30, carbPercent: 40, fatPercent: 30 };
const dataCache = {}; // Client-side cache for performance

// =================================================================================
// DOM ELEMENTS
// =================================================================================
const allPages = {
    input: document.getElementById('page-input'),
    daily: document.getElementById('page-daily-dashboard'),
    summary: document.getElementById('page-summary-dashboard'),
    settings: document.getElementById('page-settings')
};
const loadingOverlay = document.getElementById('loading-overlay'), loadingText = document.getElementById('loading-text');
const aiDescription = document.getElementById('ai-description');
const inputs = {
    cal: document.getElementById('calories'), carb: document.getElementById('carbs'), fat: document.getElementById('fat'), prot: document.getElementById('protein'),
    text: document.getElementById('text-input'), manualDesc: document.getElementById('manual-description'),
    datePicker: document.getElementById('date-picker'),
    calorieGoal: document.getElementById('calorie-goal'), proteinGoal: document.getElementById('protein-goal'), carbGoal: document.getElementById('carb-goal'), fatGoal: document.getElementById('fat-goal'),
    summaryStart: document.getElementById('summary-start-date'), summaryEnd: document.getElementById('summary-end-date')
};
const previews = { image: document.getElementById('image-preview'), text: document.getElementById('text-image-preview'), manual: document.getElementById('manual-image-preview') };
const fileInputs = ['image-camera-input', 'image-gallery-input', 'text-camera-input', 'text-gallery-input', 'manual-camera-input', 'manual-gallery-input'].map(id => document.getElementById(id));

// =================================================================================
// INITIALIZATION
// =================================================================================
document.addEventListener('DOMContentLoaded', () => {
    // Navigation
    document.getElementById('nav-input').addEventListener('click', () => showPage('input'));
    document.getElementById('nav-daily').addEventListener('click', () => showPage('daily'));
    document.getElementById('nav-summary').addEventListener('click', () => showPage('summary'));
    document.getElementById('settings-btn').addEventListener('click', () => showPage('settings'));
    document.getElementById('back-to-daily-btn').addEventListener('click', () => showPage('daily'));

    // Input Tabs
    document.getElementById('tab-btn-image').addEventListener('click', () => showTab('image'));
    document.getElementById('tab-btn-text').addEventListener('click', () => showTab('text'));
    document.getElementById('tab-btn-manual').addEventListener('click', () => showTab('manual'));

    // Actions
    fileInputs.forEach(input => input.addEventListener('change', handleImageSelection));
    document.getElementById('analyze-text-btn').addEventListener('click', analyzeText);
    document.getElementById('save-btn').addEventListener('click', saveData);
    document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
    inputs.datePicker.addEventListener('change', () => loadDailyData(inputs.datePicker.value));
    document.querySelectorAll('.macro-goal').forEach(input => input.addEventListener('input', updateMacroTotal));
    
    // Summary Page Actions
    document.querySelectorAll('.date-range-btn').forEach(btn => btn.addEventListener('click', handleSummaryRangePreset));
    document.getElementById('summary-custom-range-btn').addEventListener('click', handleSummaryCustomRange);

    // Initial setup
    showPage('input');
    showTab('image');
    inputs.datePicker.value = new Date().toISOString().split('T')[0];
});

// =================================================================================
// PAGE & TAB NAVIGATION
// =================================================================================
function showPage(pageKey) {
    currentPage = pageKey;
    Object.values(allPages).forEach(p => p.classList.add('hidden'));
    allPages[pageKey].classList.remove('hidden');

    const navButtons = document.querySelectorAll('.nav-button');
    navButtons.forEach(btn => btn.classList.remove('active'));
    const mainPageKey = pageKey === 'settings' ? 'daily' : pageKey;
    document.getElementById(`nav-${mainPageKey}`).classList.add('active');
    
    if (pageKey === 'daily') loadDailyData(inputs.datePicker.value);
    if (pageKey === 'summary') handleSummaryRangePreset({ target: document.querySelector('.date-range-btn[data-days="7"]') }); // Default to 7 days
    if (pageKey === 'settings') loadSettings();
}

function showTab(tabId) {
    currentTab = tabId;
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
    document.getElementById(`tab-content-${tabId}`).classList.remove('hidden');
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-btn-${tabId}`).classList.add('active');
    resetInputs();
}

// =================================================================================
// HELPER FUNCTIONS
// =================================================================================
const showLoading = (text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...') => { loadingText.textContent = text; loadingOverlay.classList.remove('hidden'); };
const hideLoading = () => loadingOverlay.classList.add('hidden');
const parseValue = (text, key) => {
    const match = text.match(new RegExp(`${key}\\s*=\\s*(\\d+\\.?\\d*)`, 'i'));
    return match ? parseFloat(match[1]) : 0;
};
const toISODateString = (date) => date.toISOString().split('T')[0];

function resetInputs() {
    aiDescription.textContent = '';
    inputs.cal.value = ''; inputs.carb.value = ''; inputs.fat.value = ''; inputs.prot.value = '';
    inputs.text.value = ''; inputs.manualDesc.value = '';
    Object.values(previews).forEach(img => { img.src = ''; img.classList.add('hidden'); });
    selectedImageBase64 = null; selectedImageName = null; selectedImageType = null;
    fileInputs.forEach(input => { input.value = ''; });
}

function clearCache() {
    const today = toISODateString(new Date());
    delete dataCache[`daily_${today}`]; // Clear today's cache
    // A simple way to clear all summary caches
    Object.keys(dataCache).forEach(key => {
        if (key.startsWith('summary_')) {
            delete dataCache[key];
        }
    });
    // Clear settings cache
    delete dataCache['settings'];
}

// =================================================================================
// PAGE 1: INPUT LOGIC
// =================================================================================
function handleImageSelection(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        selectedImageBase64 = e.target.result; selectedImageName = file.name; selectedImageType = file.type;
        const currentPreview = previews[currentTab];
        if (currentPreview) { currentPreview.src = selectedImageBase64; currentPreview.classList.remove('hidden'); }
        if (currentTab === 'image') analyzeImage(selectedImageBase64);
    };
    reader.readAsDataURL(file);
}
async function callGeminiAPI(payload) {
    // Using gemini-1.5-flash-latest for faster responses.
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
    const result = await response.json();
    return result.candidates[0].content.parts[0].text;
}
async function analyzeImage(base64Image) {
    showLoading('AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...');
    const prompt = "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î1 ‡πÅ‡∏Ñ‡∏•=‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£,‡∏Ñ‡∏≤‡∏ö=‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£,‡πÑ‡∏Ç‡∏°‡∏±‡∏ô=‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£,‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô=‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£ ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà2 ‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏Ñ‡∏•= 1050, ‡∏Ñ‡∏≤‡∏ö= 80, ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô= 70, ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô= 30 ‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏Ñ‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≤‡∏ß‡∏£‡∏≤‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏õ‡∏•‡∏≤‡∏´‡∏°‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß1‡∏ü‡∏≠‡∏á ‡∏ñ‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏à‡∏∞‡∏ï‡πà‡∏≥‡∏Å‡πá‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏°‡∏≤‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö";
    try {
        const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mime_type: "image/jpeg", data: base64Image.split(',')[1] } }] }] };
        const text = await callGeminiAPI(payload);
        const [nutritionLine = '', descriptionLine = ''] = text.split('\n');
        inputs.cal.value = parseValue(nutritionLine, '‡πÅ‡∏Ñ‡∏•'); inputs.carb.value = parseValue(nutritionLine, '‡∏Ñ‡∏≤‡∏ö');
        inputs.fat.value = parseValue(nutritionLine, '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô'); inputs.prot.value = parseValue(nutritionLine, '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô');
        aiDescription.textContent = descriptionLine;
    } catch (error) { console.error('Gemini Image Analysis Error:', error); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'); } finally { hideLoading(); }
}
async function analyzeText() {
    const foodText = inputs.text.value.trim(); if (!foodText) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£');
    showLoading('AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...');
    const prompt = `‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "${foodText}" ‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤ ‡πÅ‡∏Ñ‡∏•=‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£,‡∏Ñ‡∏≤‡∏ö=‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£,‡πÑ‡∏Ç‡∏°‡∏±‡∏ô=‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£,‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô=‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£ ‡πÅ‡∏•‡∏∞‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ‡∏ß‡πà‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÅ‡∏Ñ‡∏•=150,‡∏Ñ‡∏≤‡∏ö=25,‡πÑ‡∏Ç‡∏°‡∏±‡∏ô=2,‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô=8 ‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢ 1 ‡∏ó‡∏±‡∏û‡∏û‡∏µ`;
    try {
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        const text = await callGeminiAPI(payload);
        const lines = text.split('\n');
        const nutritionLine = lines.find(line => line.includes('‡πÅ‡∏Ñ‡∏•')) || '';
        const descriptionLine = lines.find(line => !line.includes('‡πÅ‡∏Ñ‡∏•=')) || foodText;
        inputs.cal.value = parseValue(nutritionLine, '‡πÅ‡∏Ñ‡∏•'); inputs.carb.value = parseValue(nutritionLine, '‡∏Ñ‡∏≤‡∏ö');
        inputs.fat.value = parseValue(nutritionLine, '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô'); inputs.prot.value = parseValue(nutritionLine, '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô');
        aiDescription.textContent = descriptionLine;
    } catch (error) { console.error('Gemini Text Analysis Error:', error); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°'); } finally { hideLoading(); }
}
async function saveData() {
    if (GAS_URL.includes('PASTE YOUR WEB APP URL HERE')) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    if (!inputs.cal.value || parseFloat(inputs.cal.value) <= 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà');
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
    const description = (currentTab === 'manual' && inputs.manualDesc.value.trim()) ? inputs.manualDesc.value.trim() : (aiDescription.textContent || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏á');
    const params = new URLSearchParams({ action: 'saveFood', calories: inputs.cal.value, carbs: inputs.carb.value || 0, fat: inputs.fat.value || 0, protein: inputs.prot.value || 0, description: description });
    if (selectedImageBase64) {
        params.append('base64Data', selectedImageBase64.split(',')[1]); params.append('fileName', selectedImageName || 'image.jpg'); params.append('mimeType', selectedImageType || 'image/jpeg');
    }
    try {
        const response = await fetch(GAS_URL, { method: 'POST', body: params });
        const result = await response.json();
        if (result.status === 'success') { 
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); 
            clearCache(); // Invalidate cache on new data
            resetInputs(); 
            showTab('image'); 
        } else { throw new Error(result.message || 'Unknown error'); }
    } catch (error) { console.error('Save Data Error:', error); alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${error.message}`); } finally { hideLoading(); }
}

// =================================================================================
// PAGE 2: DAILY DASHBOARD LOGIC
// =================================================================================
async function loadDailyData(date) {
    if (!date) return;
    const cacheKey = `daily_${date}`;
    if (dataCache[cacheKey]) {
        console.log('Serving daily data from cache for', date);
        renderDailyDashboard(dataCache[cacheKey].data, dataCache[cacheKey].settings);
        return;
    }

    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô...');
    try {
        const response = await fetch(`${GAS_URL}?action=getDailyData&date=${date}`);
        if (!response.ok) throw new Error('Network response was not ok.');
        const result = await response.json();
        if (result.status === 'success') {
            dataCache[cacheKey] = { data: result.data, settings: result.settings }; // Save to cache
            userSettings = result.settings;
            renderDailyDashboard(result.data, result.settings);
        } else { throw new Error(result.message); }
    } catch (error) {
        console.error('Error loading daily data:', error);
        document.getElementById('daily-food-list').innerHTML = `<p class="text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
    } finally { hideLoading(); }
}

function renderDailyDashboard(data, settings) {
    const totals = data.reduce((acc, item) => {
        acc.cal += parseFloat(item.calories || 0); acc.carb += parseFloat(item.carbs || 0);
        acc.fat += parseFloat(item.fat || 0); acc.prot += parseFloat(item.protein || 0);
        return acc;
    }, { cal: 0, carb: 0, fat: 0, prot: 0 });
    renderComparison(totals, settings);
    renderDailyCaloriePieChart(totals.cal, settings.calorieGoal);
    renderDailyMacroPieChart(totals);
    renderFoodList(data);
}

function createProgressBar(label, consumed, goal) {
    const percentage = goal > 0 ? (consumed / goal) * 100 : 0;
    const isOver = percentage > 100;
    const displayPercentage = Math.min(percentage, 100);
    return `<div><div class="flex justify-between text-sm mb-1"><span>${label}</span><span>${consumed.toFixed(1)} / ${goal.toFixed(1)} g</span></div><div class="progress-bar"><div class="progress-bar-inner ${isOver ? 'over' : ''}" style="width: ${displayPercentage}%"></div></div></div>`;
}

function renderComparison(totals, settings) {
    const { calorieGoal, proteinPercent, carbPercent, fatPercent } = settings;
    const goals = { prot: (calorieGoal * (proteinPercent / 100)) / 4, carb: (calorieGoal * (carbPercent / 100)) / 4, fat: (calorieGoal * (fatPercent / 100)) / 9 };
    document.getElementById('daily-comparison').innerHTML = `<div class="text-center mb-3"><span class="text-3xl font-bold">${totals.cal.toFixed(0)}</span><span class="text-lg text-slate-400">/ ${calorieGoal.toFixed(0)} kcal</span></div><div class="space-y-3">${createProgressBar('‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô', totals.prot, goals.prot)}${createProgressBar('‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï', totals.carb, goals.carb)}${createProgressBar('‡πÑ‡∏Ç‡∏°‡∏±‡∏ô', totals.fat, goals.fat)}</div>`;
}

async function fetchAndDisplayImage(fileId, imgElement) {
    try {
        const cacheKey = `image_${fileId}`;
        if (dataCache[cacheKey]) {
            imgElement.src = dataCache[cacheKey];
            return;
        }

        const response = await fetch(`${GAS_URL}?action=getImageData&fileId=${fileId}`);
        if (!response.ok) throw new Error('Failed to fetch image data');
        const result = await response.json();

        if (result.status === 'success') {
            const imageUrl = `data:${result.mimeType};base64,${result.base64Data}`;
            dataCache[cacheKey] = imageUrl; // Cache the base64 image
            imgElement.src = imageUrl;
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error(`Could not load image for fileId ${fileId}:`, error);
        // Keep the placeholder src
    }
}

function renderFoodList(data) {
    const foodListContainer = document.getElementById('daily-food-list');
    if (data.length === 0) { foodListContainer.innerHTML = `<p class="text-center text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>`; return; }
    foodListContainer.innerHTML = data.map((item, index) => {
        const itemDate = new Date(item.date);
        const timeString = itemDate.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        
        let fileId = null;
        if (item.imageUrl && item.imageUrl.includes('id=')) {
            try {
                fileId = item.imageUrl.split('id=')[1].split('&')[0];
            } catch (e) {
                console.error("Could not parse fileId from URL", item.imageUrl);
            }
        }

        const imageTag = fileId 
            ? `<img id="food-image-${index}" data-file-id="${fileId}" src="https://placehold.co/64x64/475569/94a3b8?text=..." alt="Food" class="w-16 h-16 object-cover rounded-md">`
            : `<img src="https://placehold.co/64x64/475569/94a3b8?text=‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ" alt="Food" class="w-16 h-16 object-cover rounded-md">`;

        return `
        <div class="bg-slate-700 p-3 rounded-lg shadow flex items-center space-x-4">
            ${imageTag}
            <div class="flex-1">
                <div class="flex justify-between items-start">
                    <p class="font-semibold text-slate-100">${item.description || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£'}</p>
                    <span class="text-xs text-slate-400 whitespace-nowrap">${timeString} ‡∏ô.</span>
                </div>
                <p class="text-sm text-slate-300">‡πÅ‡∏Ñ‡∏•: ${item.calories || 0} | ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô: ${item.protein || 0}g | ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö: ${item.carbs || 0}g | ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô: ${item.fat || 0}g</p>
            </div>
        </div>`;
    }).join('');

    // After setting the innerHTML, go and fetch the images
    document.querySelectorAll('img[data-file-id]').forEach(imgElement => {
        const fileId = imgElement.dataset.fileId;
        fetchAndDisplayImage(fileId, imgElement);
    });
}


// =================================================================================
// PAGE 3: SUMMARY DASHBOARD LOGIC
// =================================================================================
function handleSummaryRangePreset(event) {
    const days = parseInt(event.target.dataset.days, 10);
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - (days - 1));
    
    inputs.summaryStart.value = toISODateString(startDate);
    inputs.summaryEnd.value = toISODateString(endDate);
    
    document.querySelectorAll('.date-range-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');

    loadSummaryData(toISODateString(startDate), toISODateString(endDate));
}

function handleSummaryCustomRange() {
    const startDate = inputs.summaryStart.value;
    const endDate = inputs.summaryEnd.value;
    if (!startDate || !endDate) { return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); }
    if (new Date(startDate) > new Date(endDate)) { return alert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); }
    document.querySelectorAll('.date-range-btn').forEach(b => b.classList.remove('active'));
    loadSummaryData(startDate, endDate);
}

async function loadSummaryData(startDate, endDate) {
    const cacheKey = `summary_${startDate}_${endDate}`;
    if (dataCache[cacheKey]) {
        console.log('Serving summary data from cache');
        renderSummaryLineChart(dataCache[cacheKey]);
        renderSummaryNutrientChart(dataCache[cacheKey]);
        return;
    }

    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°...');
    try {
        const response = await fetch(`${GAS_URL}?action=getSummaryData&startDate=${startDate}&endDate=${endDate}`);
        if (!response.ok) throw new Error('Network response was not ok.');
        const result = await response.json();
        if (result.status === 'success') {
            dataCache[cacheKey] = result.data; // Save to cache
            renderSummaryLineChart(result.data);
            renderSummaryNutrientChart(result.data);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error loading summary data:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°');
    } finally {
        hideLoading();
    }
}

// =================================================================================
// PAGE 4: SETTINGS LOGIC
// =================================================================================
async function loadSettings() {
    if (dataCache['settings']) {
        console.log('Serving settings from cache');
        const settings = dataCache['settings'];
        inputs.calorieGoal.value = settings.calorieGoal; inputs.proteinGoal.value = settings.proteinPercent;
        inputs.carbGoal.value = settings.carbPercent; inputs.fatGoal.value = settings.fatPercent;
        updateMacroTotal();
        return;
    }
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...');
    try {
        const response = await fetch(`${GAS_URL}?action=getSettings`);
        const result = await response.json();
        if (result.status === 'success') {
            dataCache['settings'] = result.settings; // Save to cache
            userSettings = result.settings;
            inputs.calorieGoal.value = userSettings.calorieGoal; inputs.proteinGoal.value = userSettings.proteinPercent;
            inputs.carbGoal.value = userSettings.carbPercent; inputs.fatGoal.value = userSettings.fatPercent;
            updateMacroTotal();
        } else { throw new Error(result.message); }
    } catch (error) { console.error('Error loading settings:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ'); } finally { hideLoading(); }
}
async function saveSettings() {
    const totalPercent = ['protein', 'carb', 'fat'].reduce((sum, id) => sum + (parseFloat(inputs[id + 'Goal'].value) || 0), 0);
    if (totalPercent !== 100) { return alert(`‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 100% (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ ${totalPercent}%)`); }
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...');
    const params = new URLSearchParams({ action: 'saveSettings', calorieGoal: inputs.calorieGoal.value || 2000, proteinPercent: inputs.proteinGoal.value || 30, carbPercent: inputs.carbGoal.value || 40, fatPercent: inputs.fatGoal.value || 30, });
    try {
        const response = await fetch(GAS_URL, { method: 'POST', body: params });
        const result = await response.json();
        if (result.status === 'success') { 
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            clearCache(); // Invalidate cache on settings change
            showPage('daily'); 
        } else { throw new Error(result.message); }
    } catch (error) { console.error('Save Settings Error:', error); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤'); } finally { hideLoading(); }
}
function updateMacroTotal() {
    const total = ['protein', 'carb', 'fat'].reduce((sum, id) => sum + (parseFloat(inputs[id + 'Goal'].value) || 0), 0);
    const totalEl = document.getElementById('macro-percentage-total');
    totalEl.textContent = `‡∏£‡∏ß‡∏°: ${total}%`;
    totalEl.style.color = total === 100 ? '#4ade80' : '#f87171'; // green-400 or red-400
}

// =================================================================================
// CHART RENDERING FUNCTIONS
// =================================================================================
const chartTextColor = '#cbd5e1'; // slate-300
const chartGridColor = 'rgba(100, 116, 139, 0.5)'; // slate-500 with alpha

function renderChart(ctx, chartInstance, type, data, options) {
    if (chartInstance) chartInstance.destroy();
    return new Chart(ctx, { type, data, options });
}

function renderDailyCaloriePieChart(consumed, goal) {
    const remaining = Math.max(0, goal - consumed);
    const ctx = document.getElementById('daily-calorie-pie-chart').getContext('2d');
    dailyCaloriePieChart = renderChart(ctx, dailyCaloriePieChart, 'pie', {
        labels: ['‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'], datasets: [{ data: [consumed, remaining], backgroundColor: ['#f43f5e', '#475569'] }] // rose-500, slate-600
    }, { responsive: true, plugins: { legend: { display: true, labels: { color: chartTextColor } } } });
}

function renderDailyMacroPieChart(totals) {
    const { prot, carb, fat } = totals; const totalMacros = prot + carb + fat;
    const ctx = document.getElementById('daily-macro-pie-chart').getContext('2d');
    dailyMacroPieChart = renderChart(ctx, dailyMacroPieChart, 'pie', {
        labels: ['‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô', '‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï', '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô'], datasets: [{ data: totalMacros > 0 ? [prot, carb, fat] : [1, 1, 1], backgroundColor: ['#6366f1', '#2dd4bf', '#a78bfa'] }] // indigo-500, teal-400, violet-400
    }, { responsive: true, plugins: { legend: { position: 'top', labels: { color: chartTextColor } } } });
}

function renderSummaryLineChart(data) {
    const ctx = document.getElementById('summary-line-chart').getContext('2d');
    const labels = data.map(d => new Date(d.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }));
    const calories = data.map(d => d.calories);
    summaryLineChart = renderChart(ctx, summaryLineChart, 'line', {
        labels: labels, datasets: [{ label: '‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà', data: calories, borderColor: '#818cf8', tension: 0.1, fill: false }] // indigo-400
    }, { 
        responsive: true, 
        scales: { 
            y: { beginAtZero: true, ticks: { color: chartTextColor }, grid: { color: chartGridColor } },
            x: { ticks: { color: chartTextColor }, grid: { color: chartGridColor } }
        },
        plugins: { legend: { labels: { color: chartTextColor } } }
    });
}

function renderSummaryNutrientChart(data) {
    const ctx = document.getElementById('summary-nutrient-chart').getContext('2d');
    
    const labels = data.map(d => new Date(d.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }));
    
    const proteinGrams = data.map(d => d.protein);
    const carbGrams = data.map(d => d.carbs);
    const fatGrams = data.map(d => d.fat);

    summaryNutrientChart = renderChart(ctx, summaryNutrientChart, 'bar', {
        labels: labels,
        datasets: [
            { label: '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (g)', data: proteinGrams, backgroundColor: '#6366f1' }, // indigo-500
            { label: '‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï (g)', data: carbGrams, backgroundColor: '#2dd4bf' }, // teal-400
            { label: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô (g)', data: fatGrams, backgroundColor: '#a78bfa' } // violet-400
        ]
    }, {
        responsive: true,
        scales: {
            x: { stacked: true, ticks: { color: chartTextColor }, grid: { color: chartGridColor } },
            y: { stacked: true, beginAtZero: true, title: { display: true, text: '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (‡∏Å‡∏£‡∏±‡∏°)', color: chartTextColor }, ticks: { color: chartTextColor }, grid: { color: chartGridColor } }
        },
        plugins: { tooltip: { mode: 'index', intersect: false }, legend: { labels: { color: chartTextColor } } }
    });
}

</script>
</body>
</html>
